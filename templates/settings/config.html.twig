<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ 'OpenCoreEMR Sinch Conversations Settings'|xlt }}</title>
    <link rel="stylesheet" href="{{ webroot }}/public/assets/bootstrap/dist/css/bootstrap.min.css">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .settings-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-label {
            font-weight: 600;
            color: #495057;
        }
        .help-text {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        .section-header {
            margin-top: 2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #dee2e6;
        }
        .section-header:first-of-type {
            margin-top: 0;
        }
        .test-connection-btn {
            margin-top: 1rem;
        }
        .alert {
            margin-bottom: 1.5rem;
        }
        .password-field {
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="settings-container">
        <h1 class="mb-4">{{ 'OpenCoreEMR Sinch Conversations Settings'|xlt }}</h1>

        {% if success_message %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                {{ success_message|text }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endif %}

        <div class="alert alert-info" role="alert">
            <strong>{{ 'Note:'|xlt }}</strong>
            {{ 'You can also configure these settings via Administration > Globals > OpenCoreEMR Sinch Conversations'|xlt }}
        </div>

        <form method="post" action="?action=save">
            <input type="hidden" name="csrf_token" value="{{ csrf_token|attr }}">

            {# Sinch API Configuration #}
            <div class="section-header">
                <h3>{{ 'Sinch API Configuration'|xlt }}</h3>
                <p class="help-text">
                    {{ 'Get your API credentials from the Sinch Dashboard at https://dashboard.sinch.com'|xlt }}
                </p>
            </div>

            <div class="mb-3">
                <label for="project_id" class="form-label">{{ 'Project ID'|xlt }} <span class="text-danger">*</span></label>
                <input
                    type="text"
                    class="form-control"
                    id="project_id"
                    name="project_id"
                    value="{{ settings.project_id|attr }}"
                    required
                >
                <div class="help-text">{{ 'Your Sinch project ID from the Sinch dashboard'|xlt }}</div>
            </div>

            <div class="mb-3">
                <label for="app_id" class="form-label">{{ 'App ID'|xlt }} <span class="text-danger">*</span></label>
                <input
                    type="text"
                    class="form-control"
                    id="app_id"
                    name="app_id"
                    value="{{ settings.app_id|attr }}"
                    required
                >
                <div class="help-text">{{ 'Your Sinch app ID for the Conversations API'|xlt }}</div>
            </div>

            <div class="mb-3">
                <label for="api_key" class="form-label">{{ 'API Key'|xlt }} <span class="text-danger">*</span></label>
                <input
                    type="text"
                    class="form-control password-field"
                    id="api_key"
                    name="api_key"
                    value="{{ settings.api_key|attr }}"
                    required
                >
                <div class="help-text">{{ 'Your Sinch API key (Access Key ID)'|xlt }}</div>
            </div>

            <div class="mb-3">
                <label for="api_secret" class="form-label">{{ 'API Secret'|xlt }}</label>
                <input
                    type="password"
                    class="form-control password-field"
                    id="api_secret"
                    name="api_secret"
                    placeholder="{{ 'Leave blank to keep existing secret'|xlt }}"
                >
                <div class="help-text">
                    {{ 'Your Sinch API secret (Access Key Secret). Leave blank to keep the existing secret.'|xlt }}
                </div>
            </div>

            <div class="mb-3">
                <label for="region" class="form-label">{{ 'API Region'|xlt }} <span class="text-danger">*</span></label>
                <select class="form-select" id="region" name="region" required>
                    <option value="us" {% if settings.region == 'us' %}selected{% endif %}>
                        {{ 'United States (us)'|xlt }}
                    </option>
                    <option value="eu" {% if settings.region == 'eu' %}selected{% endif %}>
                        {{ 'Europe (eu)'|xlt }}
                    </option>
                </select>
                <div class="help-text">{{ 'Select the region where your Sinch project is hosted'|xlt }}</div>
            </div>

            {# Messaging Configuration #}
            <div class="section-header">
                <h3>{{ 'Messaging Configuration'|xlt }}</h3>
            </div>

            <div class="mb-3">
                <label for="default_channel" class="form-label">{{ 'Default Channel'|xlt }} <span class="text-danger">*</span></label>
                <select class="form-select" id="default_channel" name="default_channel" required>
                    <option value="SMS" {% if settings.default_channel == 'SMS' %}selected{% endif %}>
                        {{ 'SMS'|xlt }}
                    </option>
                    <option value="WHATSAPP" {% if settings.default_channel == 'WHATSAPP' %}selected{% endif %}>
                        {{ 'WhatsApp'|xlt }}
                    </option>
                    <option value="RCS" {% if settings.default_channel == 'RCS' %}selected{% endif %}>
                        {{ 'RCS'|xlt }}
                    </option>
                </select>
                <div class="help-text">{{ 'Default messaging channel for new conversations'|xlt }}</div>
            </div>

            <div class="mb-3">
                <label for="clinic_name" class="form-label">{{ 'Clinic Name'|xlt }}</label>
                <input
                    type="text"
                    class="form-control"
                    id="clinic_name"
                    name="clinic_name"
                    value="{{ settings.clinic_name|attr }}"
                >
                <div class="help-text">{{ 'Clinic name to appear in message templates (e.g., "Example Clinic")'|xlt }}</div>
            </div>

            <div class="mb-3">
                <label for="clinic_phone" class="form-label">{{ 'Clinic Phone'|xlt }}</label>
                <input
                    type="text"
                    class="form-control"
                    id="clinic_phone"
                    name="clinic_phone"
                    value="{{ settings.clinic_phone|attr }}"
                    placeholder="650-123-4567"
                >
                <div class="help-text">{{ 'Clinic phone number for message templates (e.g., "650-123-4567")'|xlt }}</div>
            </div>

            {# Actions #}
            <div class="d-flex gap-2 mt-4">
                <button type="submit" class="btn btn-primary">
                    {{ 'Save Settings'|xlt }}
                </button>
                <button type="button" class="btn btn-secondary" id="test-connection-btn">
                    {{ 'Test API Connection'|xlt }}
                </button>
                <button type="button" class="btn btn-info" id="sync-templates-btn">
                    {{ 'Sync Templates to Sinch'|xlt }}
                </button>
            </div>
        </form>

        <div id="test-result" class="mt-3" style="display: none;">
            <div class="alert" role="alert" id="test-alert"></div>
        </div>

        <div id="sync-result" class="mt-3" style="display: none;">
            <div class="alert" role="alert" id="sync-alert"></div>
        </div>

        {# Test SMS Section #}
        <div class="section-header mt-4">
            <h3>{{ 'Send Test SMS'|xlt }}</h3>
            <p class="help-text">
                {{ 'Send a test message to verify your Sinch integration is working correctly.'|xlt }}
            </p>
        </div>

        <form id="test-sms-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token|attr }}">

            <div class="mb-3">
                <label for="test_phone" class="form-label">{{ 'Phone Number'|xlt }} <span class="text-danger">*</span></label>
                <input
                    type="tel"
                    class="form-control"
                    id="test_phone"
                    name="phone_number"
                    placeholder="+1234567890"
                    required
                >
                <div class="help-text">{{ 'Enter phone number in E.164 format (e.g., +1234567890)'|xlt }}</div>
            </div>

            <div class="mb-3">
                <label for="test_message" class="form-label">{{ 'Test Message'|xlt }} <span class="text-danger">*</span></label>
                <textarea
                    class="form-control"
                    id="test_message"
                    name="message"
                    rows="3"
                    required
                >{{ 'This is a test message from OpenCoreEMR Sinch Conversations.'|xlt }}</textarea>
                <div class="help-text">{{ 'SMS messages are limited to 160 characters per segment'|xlt }}</div>
            </div>

            <button type="submit" class="btn btn-primary" id="send-test-sms-btn">
                {{ 'Send Test SMS'|xlt }}
            </button>
        </form>

        <div id="test-sms-result" class="mt-3" style="display: none;">
            <div class="alert" role="alert" id="test-sms-alert"></div>
        </div>
    </div>

    <script src="{{ webroot }}/public/assets/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('test-connection-btn').addEventListener('click', function() {
            const btn = this;
            const resultDiv = document.getElementById('test-result');
            const alertDiv = document.getElementById('test-alert');

            btn.disabled = true;
            btn.textContent = {{ 'Testing...'|xlj }};

            const csrfToken = document.querySelector('input[name="csrf_token"]').value;

            fetch('?action=test&csrf_token=' + encodeURIComponent(csrfToken))
                .then(response => response.json())
                .then(data => {
                    resultDiv.style.display = 'block';
                    alertDiv.className = 'alert ' + (data.success ? 'alert-success' : 'alert-danger');
                    alertDiv.textContent = data.message;
                })
                .catch(error => {
                    resultDiv.style.display = 'block';
                    alertDiv.className = 'alert alert-danger';
                    alertDiv.textContent = '{{ 'Connection test failed: '|xlj }}' + error.message;
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = {{ 'Test API Connection'|xlj }};
                });
        });

        document.getElementById('sync-templates-btn').addEventListener('click', function() {
            const btn = this;
            const resultDiv = document.getElementById('sync-result');
            const alertDiv = document.getElementById('sync-alert');

            btn.disabled = true;
            btn.textContent = {{ 'Syncing...'|xlj }};

            const csrfToken = document.querySelector('input[name="csrf_token"]').value;

            fetch('?action=sync-templates&csrf_token=' + encodeURIComponent(csrfToken))
                .then(response => response.json())
                .then(data => {
                    resultDiv.style.display = 'block';
                    alertDiv.className = 'alert ' + (data.success ? 'alert-success' : 'alert-warning');
                    alertDiv.textContent = data.message;

                    // Show details if available
                    if (data.details && data.details.errors && data.details.errors.length > 0) {
                        let errorHtml = '<hr><strong>Errors:</strong><ul>';
                        data.details.errors.forEach(error => {
                            errorHtml += '<li>' + error.template_key + ': ' + error.error + '</li>';
                        });
                        errorHtml += '</ul>';
                        alertDiv.innerHTML = data.message + errorHtml;
                    }
                })
                .catch(error => {
                    resultDiv.style.display = 'block';
                    alertDiv.className = 'alert alert-danger';
                    alertDiv.textContent = '{{ 'Template sync failed: '|xlj }}' + error.message;
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = {{ 'Sync Templates to Sinch'|xlj }};
                });
        });

        document.getElementById('test-sms-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const btn = document.getElementById('send-test-sms-btn');
            const resultDiv = document.getElementById('test-sms-result');
            const alertDiv = document.getElementById('test-sms-alert');
            const formData = new FormData(this);

            btn.disabled = true;
            btn.textContent = {{ 'Sending...'|xlj }};

            fetch('?action=test-sms', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    resultDiv.style.display = 'block';
                    alertDiv.className = 'alert ' + (data.success ? 'alert-success' : 'alert-danger');
                    alertDiv.textContent = data.message;

                    if (data.success) {
                        document.getElementById('test-sms-form').reset();
                    }
                })
                .catch(error => {
                    resultDiv.style.display = 'block';
                    alertDiv.className = 'alert alert-danger';
                    alertDiv.textContent = '{{ 'Failed to send test SMS: '|xlj }}' + error.message;
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = {{ 'Send Test SMS'|xlj }};
                });
        });
    </script>
</body>
</html>
